<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="generator" content="pandoc">
  <meta name="author" content="Alyssa Ross, FreeAgent">
  <title>You may have encountered a bug in the Ruby interpreter</title>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">
  <link rel="stylesheet" href="reveal.js/css/reveal.css">
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="reveal.js/css/theme/white.css" id="theme">
  <!-- Printing and PDF exports -->
  <script>
    var link = document.createElement( 'link' );
    link.rel = 'stylesheet';
    link.type = 'text/css';
    link.href = window.location.search.match( /print-pdf/gi ) ? 'reveal.js/css/print/pdf.css' : 'reveal.js/css/print/paper.css';
    document.getElementsByTagName( 'head' )[0].appendChild( link );
  </script>
  <!--[if lt IE 9]>
  <script src="reveal.js/lib/js/html5shiv.js"></script>
  <![endif]-->
</head>
<body>
  <div class="reveal">
    <div class="slides">

<section id="title-slide">
  <h1 class="title">You may have encountered a bug in the Ruby interpreter</h1>
  <p class="author">Alyssa Ross, FreeAgent</p>
</section>

<section class="slide level2">

<!--
This work is licensed under the Creative Commons Attribution-ShareAlike
4.0 International License. To view a copy of this license, visit
https://creativecommons.org/licenses/by-sa/4.0/.
-->
<blockquote>
<p>I’m struggling to run our website on my computer. Middleman keeps crashing with this error (happened 6 times in the last 30minutes). Does anyone know how to fix it? Thank you!</p>
<blockquote>
<pre><code>[NOTE]
You may have encountered a bug in the Ruby interpreter or extension libraries.
Bug reports are welcome.
For details: http://www.ruby-lang.org/bugreport.html</code></pre>
</blockquote>
</blockquote>
<aside class="notes">
<p>Middleman is a static site generator.</p>
<p>It takes lots of files and produces the website, then just runs an HTTP file server.</p>
<p>We discovered Ruby 2.5 was the issue (as opposed to 2.3.1).</p>
<p>But something strange was going on here. This crash isn’t a normal crash. Ruby only produces this message if something has gone wrong with Ruby itself, or with a Ruby native extension written in C, not with our code.</p>
<p>What was going on?</p>
</aside>
</section>
<section id="can-we-reproduce" class="slide level2">
<h2>Can we reproduce?</h2>
<p><code>ab -n 1000 -c 10 http://localhost:4567</code></p>
<blockquote>
<pre><code>[NOTE]
You may have encountered a bug in the Ruby interpreter or extension libraries.</code></pre>
</blockquote>
<aside class="notes">
<p>ab is ApacheBench. It produces lots of parallel requests. This command sends 1000 total requests, 10 at a time. This reliably reproduced the crash on Ruby 2.5 and 2.4 but not on 2.3. The parallelism was important. It would never crash serving one request at a time.</p>
<p>I made a simple Middleman site. That didn’t have the problem. So something we were doing was causing the crash.</p>
<p>I deleted code one line at a time, until I had the crash pared down to…</p>
</aside>
</section>
<section class="slide level2">

<div class="sourceCode" id="cb3"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb3-1" title="1">require <span class="st">&quot;fastimage&quot;</span></a>
<a class="sourceLine" id="cb3-2" title="2"></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="kw">module</span> <span class="dt">AssetTagHelpers</span></a>
<a class="sourceLine" id="cb3-4" title="4">  <span class="kw">def</span> image_size(url)</a>
<a class="sourceLine" id="cb3-5" title="5">    <span class="dt">FastImage</span>.size(<span class="st">&quot;source/components/images/</span><span class="ot">#{</span>url<span class="ot">}</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb3-6" title="6">  <span class="kw">end</span></a>
<a class="sourceLine" id="cb3-7" title="7"><span class="kw">end</span></a></code></pre></div>
<aside class="notes">
<p>So what’s FastImage?</p>
</aside>
</section>
<section id="fastimage" class="slide level2">
<h2>FastImage</h2>
<blockquote>
<p>FastImage finds the size or type of an image given its uri by fetching as little as needed</p>
</blockquote>
<aside class="notes">
<p>Written entirely in Ruby, so how could it be causing a C error? I’m skeptical.</p>
</aside>
</section>
<section class="slide level2">

<div class="sourceCode" id="cb4"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb4-1" title="1">require <span class="st">&quot;fastimage&quot;</span></a>
<a class="sourceLine" id="cb4-2" title="2"></a>
<a class="sourceLine" id="cb4-3" title="3"><span class="dt">Array</span>.new(<span class="dv">500</span>) {</a>
<a class="sourceLine" id="cb4-4" title="4">  <span class="dt">Thread</span>.new {</a>
<a class="sourceLine" id="cb4-5" title="5">    <span class="dt">FastImage</span>.size(<span class="st">&quot;source/components/images/homepage/opengraph/empathy.png&quot;</span>)</a>
<a class="sourceLine" id="cb4-6" title="6">  }</a>
<a class="sourceLine" id="cb4-7" title="7">}.each(&amp;<span class="st">:join</span>)</a></code></pre></div>
<blockquote>
<pre><code>[NOTE]
You may have encountered a bug in the Ruby interpreter or extension libraries.</code></pre>
</blockquote>
<aside class="notes">
<p>Call <code>FastImage.size</code> 500 times in parallel. This reliably crashed.</p>
<p>Time to repeat. Start deleting bits of FastImage.</p>
</aside>
</section>
<section class="slide level2">

<div class="sourceCode" id="cb6"><pre class="sourceCode ruby"><code class="sourceCode ruby"><a class="sourceLine" id="cb6-1" title="1"><span class="dv">500</span>.times <span class="kw">do</span></a>
<a class="sourceLine" id="cb6-2" title="2">  <span class="dt">Array</span>.new(<span class="dv">200</span>) { |n|</a>
<a class="sourceLine" id="cb6-3" title="3">    <span class="dt">Thread</span>.new {</a>
<a class="sourceLine" id="cb6-4" title="4">      <span class="dt">Fiber</span>.new {</a>
<a class="sourceLine" id="cb6-5" title="5">        readable = open(<span class="dv">__FILE__</span>)</a>
<a class="sourceLine" id="cb6-6" title="6">        <span class="dt">Fiber</span>.yield readable.read(<span class="dv">1</span>)</a>
<a class="sourceLine" id="cb6-7" title="7">      }.resume</a>
<a class="sourceLine" id="cb6-8" title="8">    }</a>
<a class="sourceLine" id="cb6-9" title="9">  }.each(&amp;<span class="st">:join</span>)</a>
<a class="sourceLine" id="cb6-10" title="10"><span class="kw">end</span></a></code></pre></div>
<aside class="notes">
<p>A Fiber is a block of code that can be paused and resumed by other blocks of code. You may know them as coroutines or generators.</p>
<p>This fiber opens the file it’s being run from, reads one bite, and then yields, making <code>#resume</code> return it.</p>
<p>But, I discovered that opening the file and reading the byte weren’t even necessary. The fiber just had to be doing <em>something</em>. Allocating a string was enough – the IO just made it more likely to happen.</p>
<p>This is all stuff that comes with Ruby, so I knew at this point that what I’d found was a bug in Ruby itself. Some further experimenting with this program told us that the bug was present on macOS and Solaris, but but not on Linux. And only in Ruby 2.4 or later.</p>
<p>So what had changed?</p>
</aside>
</section>
<section class="slide level2">

<pre><code>git clone https://github.com/ruby/ruby
git bisect good v2_3_7
git bisect bad v2_4_0
git bisect run sh -c &#39;./configure &amp;&amp; make &amp;&amp; ./ruby test.rb&#39;</code></pre>
<aside class="notes">
<p>We tell git that 2.3.7 worked, but 2.4.0 didn’t. It split that range in the middle, tested whether that commit worked, then repeated, until it had isolated the commit that introduced the bug.</p>
</aside>
</section>
<section id="revision-63498" class="slide level2">
<h2>Revision 63498</h2>
<p>thread_pthread.c: enable thread cache by default</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode diff"><code class="sourceCode diff"><a class="sourceLine" id="cb8-1" title="1"><span class="kw">diff --git a/thread_pthread.c b/thread_pthread.c</span></a>
<a class="sourceLine" id="cb8-2" title="2">index 775c32a6a7..91d7215914 100644</a>
<a class="sourceLine" id="cb8-3" title="3"><span class="dt">--- a/thread_pthread.c</span></a>
<a class="sourceLine" id="cb8-4" title="4"><span class="dt">+++ b/thread_pthread.c</span></a>
<a class="sourceLine" id="cb8-5" title="5"><span class="dt">@@ -432,7 +432,7 @@ native_thread_destroy(rb_thread_t *th)</span></a>
<a class="sourceLine" id="cb8-6" title="6"> }</a>
<a class="sourceLine" id="cb8-7" title="7"></a>
<a class="sourceLine" id="cb8-8" title="8"> #ifndef USE_THREAD_CACHE</a>
<a class="sourceLine" id="cb8-9" title="9"><span class="st">-#define USE_THREAD_CACHE 0</span></a>
<a class="sourceLine" id="cb8-10" title="10"><span class="va">+#define USE_THREAD_CACHE 1</span></a>
<a class="sourceLine" id="cb8-11" title="11"> #endif</a>
<a class="sourceLine" id="cb8-12" title="12"></a>
<a class="sourceLine" id="cb8-13" title="13"> #if USE_THREAD_CACHE</a></code></pre></div>
<aside class="notes">
<p>So, there’s something called a “thread cache”, and when they turned it on by default, we started seeing our problem.</p>
<p>But, while we could turn off the thread cache, that wouldn’t be the ultimate solution.</p>
<p>So, rebase again, but this time always use the thread cache.</p>
</aside>
</section>
<section class="slide level2">

<blockquote>
<h2 id="revision-60440">Revision 60440</h2>
<p>Use rb_execution_context_t instead of rb_thread_t to represent execution context [Feature #14038]</p>
</blockquote>
<aside class="notes">
<p>Do you know what this means? I don’t.</p>
<p>But that’s okay. We can see that this is a big refactor, and looks like a plausible place for a bug to have been introduced. We can check that this change is what introduces the bug by checking out 2.4, reverting just this commit, and verifying that it doesn’t crash.</p>
<p>We now have enough information to file a bug report!</p>
</aside>
</section>
<section class="slide level2">

<blockquote>
<h2 id="bug-15250">Bug #15250</h2>
<p>Getting the segfault doesn’t require nearly that many iterations or threads, I just made sure to do it a lot so I could reproduce it consistently. I’ve seen it fail with as few as 20 threads.</p>
<p>The IO isn’t necessary either. The Fiber just needs to have some work to do. I got it to break once by just yielding “hello world”. The IO is more consistent, though.</p>
<p>I came across this bug in the wild when using the fastimage gem in a few threads (from middleman), which uses a Fiber to wrap IO operations.</p>
<p>I’ve been able to reproduce on macOS 10.13, and SmartOS 2017Q4 (Solaris). I have not been able to reproduce on Linux.</p>
<p>As best I can tell, the crash was introduced by r60440. It is present in Ruby 2.5.x when compiled with the default configuration. It is not present in 2.4.x. It’s also present in trunk, but only if USE_THREAD_CACHE is disabled. (Or at least, I can’t reproduce it with thread caching enabled.)</p>
</blockquote>
<aside class="notes">
<p>I filed this bug report. And then I waited.</p>
</aside>
</section>
<section class="slide level2">

<blockquote>
<blockquote>
<p>Sounds like a duplicate of #14561. It should be fixed on trunk already.</p>
</blockquote>
<p>Yes! I can confirm that this now appears to be fixed on trunk.</p>
</blockquote>
<aside class="notes">
<p>By the time they got to my bug, they’d already fixed it! Oh well.</p>
<p>The good news is, it’s fixed. Ruby 2.6 came out on 25 December, and it no longer has this crash.</p>
</aside>
</section>
<section id="sound-interesting" class="slide level2">
<h2>Sound interesting?</h2>
<p>Join us in Dev Platform at FreeAgent!</p>
<ul>
<li>Help people with weeeeeeeeeeeird bugs</li>
<li>Run a HUGE CI cluster</li>
<li>Make nice tools for your nice colleagues</li>
</ul>
<p>https://www.freeagent.com/careers/</p>
</section>
<section id="keep-in-touch" class="slide level2">
<h2>Keep in touch</h2>
<dl>
<dt>Get slides, including detailed speaker notes</dt>
<dd>https://github.com/alyssais/ruby-fiber-talk
</dd>
<dt>Contact me</dt>
<dd>alyssa.ross@freeagent.com
</dd>
<dt>OpenPGP</dt>
<dd><code>7573 56D7 79BB B888 773E</code>
</dd>
<dd><code>415E 736C CDF9 EF51 BD97</code>
</dd>
</dl>
</section>
    </div>
  </div>

  <script src="reveal.js/lib/js/head.min.js"></script>
  <script src="reveal.js/js/reveal.js"></script>

  <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        // Display controls in the bottom right corner
        controls: false,
        // Display a presentation progress bar
        progress: false,
        // Push each slide change to the browser history
        history: true,
        // Transition style
        transition: 'none', // none/fade/slide/convex/concave/zoom

        // Optional reveal.js plugins
        dependencies: [
          { src: 'reveal.js/lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'reveal.js/plugin/zoom-js/zoom.js', async: true },
          { src: 'reveal.js/plugin/notes/notes.js', async: true }
        ]
      });
    </script>
    </body>
</html>
